!function(e,t){"function"==typeof define&&define.amd?define(["WorkerEventDispatcher"],t):"object"==typeof module&&module.exports?module.exports=t(require("WorkerEventDispatcher")):e.WorkerInterface=t(e.WorkerEventDispatcher)}(this,function(WorkerEventDispatcher){function generateWorkerBlobData(e){e=e instanceof Array?e:[String(e)];for(var t=e.length,r=0;t>r;r++)e[r]=WorkerInterface.fullImportScriptURL(e[r]);return generateBlob([Scripts.DEPS_SRC,Scripts.INTERFACE_SRC,Scripts.SELF_SRC.replace("{$}",e.join('", "'))],"text/javascript;charset=UTF-8")}function generateBlob(e,t){var r=new Blob(e instanceof Array?e:[e],{type:t||"text/plain;charset=UTF-8"});return window.URL.createObjectURL(r)}function fullImportScriptURL(e){if(e.search(/^\w+\:\/\//)>=0)return e;var t=window.location.origin,r=window.location.pathname.match(/([^\/\\]+)(?:\/|\\)+/g);if("/"===e.charAt())t+=e;else if("../"===e.substr(0,3)){for(var n=e.match(/([^\/\\]+)(?:\/|\\)+/g);n.length&&r.length&&"../"===n[0];)n.shift(),r.pop();t+="/"+r.join("")+n.join("")+e.match(/[^\/\\]*$/g)[0]}else t+="./"===e.substr(0,2)?"/"+r.join("")+e.substring(2):"/"+r.join("")+e;return t}function isStandalone(){return"undefined"!=typeof Scripts&&Scripts.hasOwnProperty("SELF_SRC")}function evaluateRequest(type,cmd,value,target){var handler,result=void 0;switch(type){case CommandType.CALL:with(target)cmd?(eval("handler = "+cmd),result=handler.apply(target,value)):result=target.apply(null,value);break;case CommandType.EXEC:with(target)eval("result = (function(target) { with(target){ return "+cmd+"; }})(target);");break;case CommandType.GET:with(target)eval("result = "+cmd);break;case CommandType.SET:eval("handler = function(value, target) { with(target) { "+cmd+" = value; } };"),handler(value,target);break;case CommandType.DESTROY_TARGET:TargetPool.instance.remove(target)}return result}function TargetPool(){var e=new Map;this.set=function(t){var r=null;if(TargetPool.isValidTarget(t))if(e.has(t))r=e.get(t);else{var n=getId();r=new RequestTargetLink(this,t,n),e.set(n,r),e.set(t,r)}return r},this.has=function(t){return e.has(t)},this.get=function(t){return e.get(t)},this.remove=function(t){var r=e.get(t);r&&(e["delete"](r.id),e["delete"](r.target),r.destroy())},this.clear=function(){for(var t=e.keys(),r=t.length,n=0;r>n;n++){var a=t[n];if("string"==typeof a){var o=e.get(a);o.destroy()}}e.clear()},Object.defineProperties(this,{id:{value:getId()}})}function WorkerInterfaceBase(e,t){function r(){l.removeEventListener(Events.READY_EVENT,r),f.resolve(RequestTargetLink.getLink(""))}function n(e){var t,r,n=e.data;try{r=n.target?TargetPool.instance.get(n.target):g,t=evaluateRequest(n.type,n.cmd,n.value,r)}catch(o){throw c({name:o.name,message:o.message},ResponseTypes.RESULT_FAILURE,n.id),o}t instanceof Promise?a(t,n.id):c(t,ResponseTypes.RESULT_SUCCESS,n.id)}function a(e,t){e.then(function(e){c(e,ResponseTypes.RESULT_SUCCESS,t)},function(e){c(e,ResponseTypes.RESULT_FAILURE,t)})}function o(e){var t=e.data,r=d[t.id];switch(delete d[t.id],t.type){default:throw new Error("Unknown package received:"+JSON.stringify(e));case ResponseTypes.RESULT_FAILURE:r.reject(t.value);break;case ResponseTypes.RESULT_SUCCESS:r.resolve(t.value)}}function i(e){return Events.internals[e.type]||(e={type:e.type,data:DataConverter.prepareToReceive(e.data,u)}),e}function s(e){return{type:e.type,data:DataConverter.prepareToSend(e.data)}}function u(e,t){var r=getId();return e.id=r,e.value=DataConverter.prepareToSend(e.value),t=t||createDeferred(r),d[r]=t,l.dispatchEvent(Events.REQUEST_EVENT,e),t.promise}function c(e,t,r){var n={id:r,type:t,value:e};l.dispatchEvent(Events.RESPONSE_EVENT,n)}var l=null,f=createDeferred(),p=new RequestTarget(f.promise,u),g={};e?(l=isStandalone()?WorkerEventDispatcher.create(generateWorkerBlobData(e),t||WorkerInterface.DEDICATED,i,s):WorkerEventDispatcher.create(e,t||WorkerInterface.DEDICATED,i,s),l.addEventListener(Events.READY_EVENT,r)):(l=WorkerEventDispatcher.self(i,s),l.dispatchEvent(Events.READY_EVENT),r());var d={};this.get=p.get.bind(p),this.set=p.set.bind(p),this.call=p.call.bind(p),this.execute=p.execute.bind(p),this.then=p.then,this["catch"]=p["catch"],Object.defineProperties(this,{dispatcher:{value:l},target:{value:this},pool:{get:function(){return g},set:function(e){g=e}}}),l.addEventListener(Events.REQUEST_EVENT,n),l.addEventListener(Events.RESPONSE_EVENT,o)}function create(e){return new WorkerInterface(e,WorkerInterface.DEDICATED)}var WorkerInterface,CommandType={GET:"get",SET:"set",CALL:"call",EXEC:"exec",DESTROY_TARGET:"destroyTarget"},Events={READY_EVENT:"~WI:Ready",REQUEST_EVENT:"~WI:Request",RESPONSE_EVENT:"~WI:Response",internals:{"~WI:Response":!0}},ResponseTypes={RESULT_SUCCESS:"success",RESULT_FAILURE:"failure"},getId=function(){var e="WI/"+String(Date.now())+"/",t=0;return function(){return e+String(++t)+"/"+String(Date.now())}}(),createDeferred=function(){function e(){this.promise=new Promise(function(e,t){this.resolve=e,this.reject=t}.bind(this))}function t(){return new e}return t}(),DataConverter=function(){function e(e){return e.target instanceof RequestTarget?e=e.target.toJSON():"function"==typeof e.toJSON&&(e=e.toJSON()),e}function t(e,t){var r=RequestTargetLink.getLinkPoolId(e);return r===TargetPool.instance.id?(e=TargetPool.instance.get(RequestTargetLink.getLinkId(e)),e&&(e=e.target)):e=new RequestTarget(Promise.resolve(e),t),e}function r(e,t,r){for(var n=[],a=e.length,o=0;a>o;o++){var i=e[o];RequestTargetLink.isLink(i)?n[o]=t(i,r):n[o]=i}return n}function n(e,t,r){var n={};for(var a in e)if(e.hasOwnProperty(a)){var o=e[a];RequestTargetLink.isLink(e)?n[a]=t(o,r):n[a]=o}return n}function a(t){var a=t,o=typeof t;return"object"===o&&null!==t?RequestTargetLink.isLink(t)?a=e(t):t instanceof Array?a=r(t,e):t.constructor===Object&&(a=n(t,e)):"function"===o&&(a=TargetPool.instance.set(t).toJSON()),a}function o(e){return e&&(e.value=a(e.value)),e}function i(e,a){var o=e;return"object"==typeof e&&null!==e&&(RequestTargetLink.isLink(e)?o=t(e,a):e instanceof Array?o=r(e,t,a):e.constructor===Object&&(o=n(e,t,a))),o}function s(e,t){return e&&(e.value=i(e.value,t)),e}function u(e){return e.target instanceof RequestTarget&&e.target.status==TargetStatus.PENDING}function c(e){function t(e){return u(e)&&a.push(e),e}var a=[];return"object"==typeof e&&null!==e&&(u(e)?a.push(e):e instanceof Array?r(e,t):e.constructor===Object&&n(e,t)),a}return{prepareToSend:o,prepareToReceive:s,lookupForPending:c}}(),TargetStatus={PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected",DESTROYED:"destroyed"},RequestTarget=function(){function e(e,t,r,n){return pack={type:e,cmd:t,value:r,target:n}}function t(e,t){var r=t.promise;switch(this.status){case TargetStatus.PENDING:this._addToQueue(e,t);break;case TargetStatus.REJECTED:r=Promise.reject(new Error("Target object was rejected and cannot be used for calls."));break;case TargetStatus.DESTROYED:r=Promise.reject(new Error("Target object was destroyed and cannot be used for calls."));break;case TargetStatus.RESOLVED:this._sendRequestHandlerPrecondition(e,t)}return r}function r(e,t){var r=DataConverter.lookupForPending(e.value);r.length?Promise.all(r).then(function(){this._sendRequestHandler(e,t)}.bind(this)):this._sendRequestHandler(e,t)}function n(t,r,n){var a=e(t,r,n,this.id),o=this._applyRequest(a,createDeferred());return new f(o,this._sendRequestHandler)}function a(e){return this._sendRequest(CommandType.GET,e)}function o(e,t){return this._sendRequest(CommandType.SET,e,t)}function i(e,t){return t?t instanceof Array||(t=[t]):t=[],this._sendRequest(CommandType.CALL,e,t)}function s(e){return this._sendRequest(CommandType.EXEC,e)}function u(){return this.status===TargetStatus.PENDING||this.status===TargetStatus.RESOLVED}function c(){return this.id&&this.status===TargetStatus.RESOLVED}function l(){var e={_targetLink_:{id:this.target.id,type:this.target.targetType,poolId:this.target.poolId}};return e}function f(e,t){function r(){var e=null;return f.canBeDestroyed()?(d=TargetStatus.DESTROYED,e=f._sendRequest(CommandType.DESTROY_TARGET)):e=Promise.reject(),e}function n(e){var t=l;return"boolean"!=typeof t&&(t="function"===RequestTargetLink.getLinkTargetType(e)?E&&1===E.length&&E[0][0].type==CommandType.CALL&&!g:E&&1===E.length&&!g),t}function a(e){return d=TargetStatus.RESOLVED,RequestTargetLink.isLink(e)&&(p=RequestTargetLink.getLinkData(e),l=n(e),l&&E[E.length-1][1].promise.then(r,r),e={target:f}),o(),e}function o(){for(;E&&E.length;){var e=E.shift(),t=e[0],r=e[1];t.target=p.id,f._sendRequestHandlerPrecondition(t,r)}E=null}function i(e){for(d=TargetStatus.REJECTED;E&&E.length;){var t=E.shift();t[1].reject(new Error("Target of the call was rejected and callcannot be sent."))}return E=null,e}function s(t,r){var n=e.then(t,r);return n&&(g=!0),n}function u(){var t=e["catch"].apply(e,arguments);return t&&(g=!0),t}function c(e,t){E.push([e,t])}var l,f=this,p={},g=!1,d=TargetStatus.PENDING,E=[];Object.defineProperties(f,{id:{get:function(){return p.id},configurable:!0},target:{get:function(){return f}},targetType:{get:function(){return p.type},configurable:!0},poolId:{get:function(){return p.poolId},configurable:!0},temporary:{get:function(){return l},set:function(e){this.isActive()&&(l=Boolean(e),d==TargetStatus.RESOLVED&&r())}},status:{get:function(){return d},configurable:!0},_sendRequestHandler:{value:t,configurable:!0},_targetLink_:{value:f}}),e=e.then(a,i),this._addToQueue=c,this.then=s,this["catch"]=u,this.destroy=r}return f.prototype.get=a,f.prototype.set=o,f.prototype.call=i,f.prototype.execute=s,f.prototype.canBeDestroyed=c,f.prototype.isActive=u,f.prototype.toJSON=l,f.prototype._sendRequest=n,f.prototype._applyRequest=t,f.prototype._sendRequestHandlerPrecondition=r,f}(),RequestTargetLink=function(){function e(e,t,r){var n=!0;Object.defineProperties(this,{poolId:{get:function(){return e?e.id:null}},target:{get:function(){return t}},id:{get:function(){return r}},_targetLink_:{value:this}}),this.destroy=function(){n&&(n=!1,r=null,e=null,t=null,e.remove(r))}}return e.prototype.toJSON=function(){return{_targetLink_:{id:this.id,type:typeof this.target,poolId:this.poolId}}},e.getLink=function(e){return{_targetLink_:{id:e||0,poolId:TargetPool.instance.id}}},e.getLinkData=function(t){var r;return e.isLink(t)&&(r=t._targetLink_),r},e.getLinkId=function(t){var r;return e.isLink(t)&&(r=t._targetLink_.id),r},e.getLinkPoolId=function(t){var r;return e.isLink(t)&&(r=t._targetLink_.poolId),r},e.getLinkTargetType=function(t){var r;return e.isLink(t)&&(r=t._targetLink_.type),r},e.isLink=function(e){return e&&"object"==typeof e._targetLink_&&e._targetLink_},e}();return TargetPool.isValidTarget=function(){var e={object:!0,"function":!0};return function(t){return t&&e[typeof t]}}(),Object.defineProperties(TargetPool,{instance:{value:new TargetPool}}),WorkerInterface="function"==typeof Proxy?function(){function e(e){return{get:function(r,n){function a(){return i}var o;if(e[n]||"symbol"==typeof n)o=r.target[n];else{var i=r.target.get(n);a.target=i,o=t(a)}return o},apply:function(e,r,n){return t(e.target.call(null,n))},set:function(t,r,n){var a;return a=e[r]||"symbol"==typeof r?t.target[r]=n:t.target.set(r,n)},has:function(e,t){return e.target.hasOwnProperty(t)},deleteProperty:function(e,t){return!1},ownKeys:function(e){return Object.getOwnPropertyNames(r)},enumerate:function(e){return Object.getOwnPropertyNames(r)},getOwnPropertyDescriptor:function(e,t){var n;return n=r.hasOwnProperty(t)?Object.getOwnPropertyDescriptor(e,t):Object.getOwnPropertyDescriptor(e.target,t)}}}function t(e){return new Proxy(e,a)}var r={arguments:!0,caller:!0,prototype:!0},n={arguments:!0,caller:!0,prototype:!0,get:!0,set:!0,call:!0,execute:!0,target:!0,then:!0,"catch":!0,_targetLink_:!0},a=e(n),o={arguments:!0,caller:!0,prototype:!0,get:!0,set:!0,call:!0,execute:!0,target:!0,dispatcher:!0,then:!0,"catch":!0,pool:!0},i=e(o),s=new Proxy(WorkerInterfaceBase,{construct:function(e,t){function r(){return n}var n=new e(t[0],t[1],t[2],t[3]);return r.target=n,new Proxy(r,i)},get:function(e,t){return e[t]},set:function(e,t,r){e[t]=r},has:function(e,t){return e.hasOwnProperty(t)},ownKeys:function(e){return Object.getOwnPropertyNames(e)},deleteProperty:function(e,t){delete e[t]}});return Object.defineProperties(s,{proxyEnabled:{value:!0}}),s}():function(){function e(e,t){WorkerInterfaceBase.apply(this,arguments)}return Object.defineProperties(e,{proxyEnabled:{value:!1}}),e}(),WorkerInterface.create=create,WorkerInterface.isStandalone=isStandalone,WorkerInterface.generateBlob=generateBlob,WorkerInterface.fullImportScriptURL=fullImportScriptURL,WorkerInterface.DEDICATED=WorkerEventDispatcher.WorkerType.DEDICATED_WORKER,WorkerInterface.WorkerEventDispatcher=WorkerEventDispatcher,WorkerInterface});