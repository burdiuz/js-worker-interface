!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.WorkerInterface=t()}(this,function(){var Scripts={INTERFACE_SRC:'function generateWorkerBlobData(e){e=e instanceof Array?e:[String(e)];for(var t=e.length,r=0;t>r;r++)e[r]=WorkerInterface.fullImportScriptURL(e[r]);return generateBlob([Scripts.INTERFACE_SRC,Scripts.SELF_SRC.replace("{$}",e.join(\'", "\'))],"text/javascript;charset=UTF-8")}function generateBlob(e,t){var r=new Blob(e instanceof Array?e:[e],{type:t||"text/plain;charset=UTF-8"});return window.URL.createObjectURL(r)}function fullImportScriptURL(e){if(e.search(/^\\w+\\:\\/\\//)>=0)return e;var t=window.location.origin,r=window.location.pathname.match(/([^\\/\\\\]+)(?:\\/|\\\\)+/g);if("/"===e.charAt())t+=e;else if("../"===e.substr(0,3)){for(var n=e.match(/([^\\/\\\\]+)(?:\\/|\\\\)+/g);n.length&&r.length&&"../"===n[0];)n.shift(),r.pop();t+="/"+r.join("")+n.join("")+e.match(/[^\\/\\\\]*$/g)[0]}else t+="./"===e.substr(0,2)?"/"+r.join("")+e.substring(2):"/"+r.join("")+e;return t}function isStandalone(){return Scripts&&Scripts.hasOwnProperty("SELF_SRC")}function createDeferred(e){var t,r,n=new Promise(function(e,n){t=e,r=n});return{id:e,resolve:t,reject:r,promise:n}}function execute(type,cmd,value,target){var handler,result=void 0;switch(data.type){case CommandType.CALL:with(target)eval("handler = "+cmd),result=handler.apply(target,value);break;case CommandType.EXEC:with(target)eval("result = "+cmd);break;case CommandType.GET:with(target)eval("result = "+cmd);break;case CommandType.SET:handler=new Function("value,target","with(target){ "+cmd+" = value; }"),handler(value,target)}return{type:ResponseTypes.RESULT_SUCCESS,value:result}}function WorkerInterface(e,t){function r(e,t,r){var n=getId(),a={type:e,id:n,cmd:t,value:r},i=createDeferred(n);return c[n]=i,o.dispatchEvent(WorkerInterface.REQUEST_EVENT,a),i.promise}function n(e){return r(CommandType.GET,e)}function a(e,t){return r(CommandType.SET,e,t)}function i(e,t){return t?t instanceof Array||(t=[t]):t=[],r(CommandType.CALL,e,t)}function s(e){return r(CommandType.EXEC,e)}var o=null;o=e?isStandalone()?WorkerEventDispatcher.create(generateWorkerBlobData(e),t||WorkerInterface.DEDICATED):WorkerEventDispatcher.create(e,t||WorkerInterface.DEDICATED):WorkerEventDispatcher.self();var c={};o.addEventListener(Events.REQUEST_EVENT,function(e){var t,r=e.data;try{t=s(r.type,r.cmd,r.value,this.pool)}catch(n){throw o.dispatchEvent(Events.RESPONSE_EVENT,{id:r.id,type:ResponseTypes.RESULT_FAILURE,value:{name:n.name,message:n.message}}),n}t.id=r.id,o.dispatchEvent(Events.RESPONSE_EVENT,t)}.bind(this)),o.addEventListener(Events.RESPONSE_EVENT,function(e){var t=e.data,r=c[t.id];switch(delete c[t.id],t.type){default:throw new Error("Unknown package received:"+JSON.stringify(e));case ResponseTypes.RESULT_FAILURE:r.reject(t.value);break;case ResponseTypes.RESULT_SUCCESS:r.resolve(t.value)}}),this.get=n,this.set=a,this.call=i,this.execute=s,this.pool={},Object.defineProperties(this,{dispatcher:{value:o,configurable:!1,writable:!1}})}var EventDispatcher=function(){function e(e){return"object"==typeof e&&null!==e}function t(){function e(e,t,r){o.add(e,t,-r||0)}function r(e){return o.has(e)}function n(e,t){o.remove(e,t)}function i(e){o.removeAll(e)}function s(e,r){o.call(t.getEvent(e,r))}var o=new a;this.addEventListener=e,this.hasEventListener=r,this.removeEventListener=n,this.removeAllEventListeners=i,this.dispatchEvent=s}function r(e,r){var n=e;return t.isObject(e)||(n=new t.Event(String(e),r)),n}var n=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function r(){return a}function n(){a=!0}var a=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=n,this.isDefaultPrevented=r}return t.prototype.toJSON=e,t}(),a=function(){function e(e,t,r){var n=i(e,r,this._listeners);n.indexOf(t)<0&&n.push(t)}function t(e){var t=!1,r=s(e,this._listeners);if(r)for(var n in r)if(r.hasOwnProperty(n)){t=!0;break}return t}function r(e,t){var r=s(e,this._listeners);if(r)for(var n=Object.getOwnPropertyNames(r),a=n.length,i=0;a>i;i++){var o=n[i],c=r[o],E=c.indexOf(t);E>=0&&(c.splice(E,1),c.length||delete r[o])}}function n(e){delete this._listeners[e]}function a(e,t){function r(){a=!0}function n(){i=!0}var a=!1,i=!1;e.stopPropagation=r,e.stopImmediatePropagation=n;var o=s(e.type,this._listeners);if(o)for(var c=Object.getOwnPropertyNames(o).sort(function(e,t){return e-t}),E=c.length,u=0;E>u&&!a;u++)for(var l=o[c[u]],v=l.length,p=0;v>p&&!i;p++){var f=l[p];f.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function i(e,t,r){var n=s(e,r,Object);return s(parseInt(t),n,Array)}function s(e,t,r){var n=null;return t.hasOwnProperty(e)?n=t[e]:r&&(n=t[e]=new r),n}function o(){this._listeners={}}return o.prototype.add=e,o.prototype.has=t,o.prototype.remove=r,o.prototype.removeAll=n,o.prototype.call=a,o}();return t.isObject=e,t.getEvent=r,t.Event=n,t}(),MessagePortDispatcher=function(){function e(r,n){function a(e){var r=t.fromJSON(e.data);r&&(r.dispatcherId===s?c.dispatchEvent(r.event):E.dispatchEvent(r.event))}function i(r,n,a){r=EventDispatcher.getEvent(r,n);var i=e.toJSON(new t(r,s));o.call(this,i,a)}r=r||self;var s="MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now()),o=n||function(e,t){r.postMessage(e,this.targetOrigin,t)},c=new EventDispatcher,E=new EventDispatcher;this.targetOrigin="*",this.addEventListener=E.addEventListener,this.hasEventListener=E.hasEventListener,this.removeEventListener=E.removeEventListener,this.removeAllEventListeners=E.removeAllEventListeners,this.dispatchEvent=i,Object.defineProperties(this,{sender:{value:c},receiver:{value:E},target:{value:r},dispatcherId:{value:s}}),r.addEventListener("message",a)}var t=function(){function t(e,t){this.event=e,this.dispatcherId=t}function r(){return{event:e.toJSON(this.event),dispatcherId:this.dispatcherId}}function n(r){var n=e.fromJSON(r);return t.isEvent(n)?n.event=e.fromJSON(n.event):n=null,n}function a(e){return EventDispatcher.isObject(e)&&e.hasOwnProperty("dispatcherId")&&e.hasOwnProperty("event")}return t.prototype.toJSON=r,t.fromJSON=n,t.isEvent=a,t}();e.toJSON=function(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)},e.fromJSON=function(e){var t;if(EventDispatcher.isObject(e))t=e;else try{t=JSON.parse(e)}catch(r){}return t};var r=null,n=null,a=null;return e.self=function(){return r||(r=new e(self)),r},e.parent=function(){return n||(n=new e(parent)),n},e.top=function(){return a||(a=new e(top)),a},e}(),WorkerEventDispatcher=function(){function e(e,t,r,n){EventDispatcher.Event.call(this,e,t),this.sourceEvent=r,this.client=n}function t(t){function r(t){var r=i.create(t.ports[0],c.SHARED_WORKER_CLIENT);a.dispatchEvent(new e(e.CONNECT,r,t,r))}var n=t||self,a=new EventDispatcher;n.addEventListener("connect",r),this.addEventListener=a.addEventListener,this.hasEventListener=a.hasEventListener,this.removeEventListener=a.removeEventListener,this.removeAllEventListeners=a.removeAllEventListeners,E.setScopeHandlers(n,a),Object.defineProperties(this,{receiver:{value:a},target:{value:n}})}function r(e){function t(){e.start()}function r(){e.close()}E.call(this,e),this.start=t,this.close=r}function n(e,t){var n=e;EventDispatcher.isObject(e)||(n=new SharedWorker(String(e),t)),r.call(this,n.port),E.setAbstractWorkerHandlers(n,this.receiver)}function a(e){function t(){return r.terminate()}var r=e||self;EventDispatcher.isObject(r)||(r=new Worker(String(e))),E.call(this,r),E.setScopeHandlers(r,this.receiver),this.terminate=t}function i(e,t){e===s?Object.defineProperties(this,{type:{value:t}}):a.call(this,e)}var s={},o={};Object.defineProperties(o,{CONNECT:{value:"connect"},MESSAGE:{value:"message"},ERROR:{value:"error"},LANGUAGECHANGE:{value:"languagechange"},ONLINE:{value:"online"},OFFLINE:{value:"offline"}}),e.createHandler=function(t,r,n){function a(t){n.hasEventListener(i)&&n.dispatchEvent(new e(i,t,t))}var i=e.getWorkerEventType(t);return r.addEventListener(t,a),a},e.getWorkerEventType=function(t){var r="";switch(t){case o.CONNECT:r=e.CONNECT;break;case o.MESSAGE:r=e.MESSAGE;break;case o.ERROR:r=e.ERROR;break;case o.LANGUAGECHANGE:r=e.LANGUAGECHANGE;break;case o.ONLINE:r=e.ONLINE;break;case o.OFFLINE:r=e.OFFLINE}return r},Object.defineProperties(e,{CONNECT:{value:"worker:connect"},MESSAGE:{value:"worker:message"},ERROR:{value:"worker:error"},LANGUAGECHANGE:{value:"worker:languagechange"},ONLINE:{value:"worker:online"},OFFLINE:{value:"worker:offline"}});var c={};Object.defineProperties(c,{DEDICATED_WORKER:{value:"dedicated"},SHARED_WORKER:{value:"shared"},SHARED_WORKER_SERVER:{value:"sharedServer"},SHARED_WORKER_CLIENT:{value:"sharedClient"}});var E=function(){function t(e){function t(t,r){e.postMessage(t,r)}MessagePortDispatcher.call(this,e,t)}function r(t,r){e.createHandler(o.ERROR,t,r),e.createHandler(o.LANGUAGECHANGE,t,r),e.createHandler(o.ONLINE,t,r),e.createHandler(o.OFFLINE,t,r)}function n(t,r){e.createHandler(o.ERROR,t,r)}return t.setScopeHandlers=r,t.setAbstractWorkerHandlers=n,t}();return t.prototype=new i(s,c.SHARED_WORKER_SERVER),t.prototype.constructor=t,r.prototype=new i(s,c.SHARED_WORKER_CLIENT),r.prototype.constructor=r,n.prototype=new i(s,c.SHARED_WORKER),n.prototype.constructor=n,a.prototype=new i(s,c.DEDICATED_WORKER),a.prototype.constructor=a,i.WorkerEvent=e,i.WorkerType=c,i.Dedicated=a,i.Shared=n,i.Server=t,i.Client=r,i.create=function(e,i){var s=null;switch(i){default:case c.DEDICATED_WORKER:s=new a(e);break;case c.SHARED_WORKER:s=new n(e);break;case c.SHARED_WORKER_SERVER:s=new t(e);break;case c.SHARED_WORKER_CLIENT:s=new r(e)}return s},i.self=function(){var e=null;return e="function"==typeof self.postMessage?new a(self):new t(self)},i}(),getId=function(){var e="CMD/",t=0;return function(){return e+String(++t)}}(),CommandType={GET:"get",SET:"set",CALL:"call",EXEC:"exec"},Events={REQUEST_EVENT:"~WI:Request",RESPONSE_EVENT:"~WI:Response"},ResponseTypes={RESULT_SUCCESS:"success",RESULT_FAILURE:"failure"};WorkerInterface.fullImportScriptURL=fullImportScriptURL,WorkerInterface.fullImportScriptURL=fullImportScriptURL,WorkerInterface.DEDICATED=WorkerEventDispatcher.WorkerType.DEDICATED_WORKER,WorkerInterface.SHARED=WorkerEventDispatcher.WorkerType.SHARED_WORKER,WorkerInterface.EventDispatcher=EventDispatcher,WorkerInterface.MessagePortDispatcher=MessagePortDispatcher,WorkerInterface.WorkerEventDispatcher=WorkerEventDispatcher;',SELF_SRC:'var api=WorkerInterface.self=new WorkerInterface;try{importScripts("{$}")}catch(error){console.log(error.name,error.message),console.log(error)}'};return eval(Scripts.INTERFACE_SRC),WorkerInterface});
