!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.WorkerInterface=t()}(this,function(){var Scripts={DEPS_SRC:'var EventDispatcher=function(){function e(e){return"object"==typeof e&&null!==e}function t(e){function n(e,t,n){c.add(e,t,-n||0)}function r(e){return c.has(e)}function a(e,t){c.remove(e,t)}function s(e){c.removeAll(e)}function o(n,r){var i=t.getEvent(n,r);e&&(i=e.call(this,i)),c.call(i)}var c=new i;this.addEventListener=n,this.hasEventListener=r,this.removeEventListener=a,this.removeAllEventListeners=s,this.dispatchEvent=o}function n(e,n){var r=e;return t.isObject(e)||(r=new t.Event(String(e),n)),r}var r=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function n(){return i}function r(){i=!0}var i=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=r,this.isDefaultPrevented=n}return t.prototype.toJSON=e,t}(),i=function(){function e(e,t,n){var r=a(e,n,this._listeners);r.indexOf(t)<0&&r.push(t)}function t(e){var t=!1,n=s(e,this._listeners);if(n)for(var r in n)if(n.hasOwnProperty(r)){t=!0;break}return t}function n(e,t){var n=s(e,this._listeners);if(n)for(var r=Object.getOwnPropertyNames(n),i=r.length,a=0;i>a;a++){var o=r[a],c=n[o],v=c.indexOf(t);v>=0&&(c.splice(v,1),c.length||delete n[o])}}function r(e){delete this._listeners[e]}function i(e,t){function n(){i=!0}function r(){a=!0}var i=!1,a=!1;e.stopPropagation=n,e.stopImmediatePropagation=r;var o=s(e.type,this._listeners);if(o)for(var c=Object.getOwnPropertyNames(o).sort(function(e,t){return e-t}),v=c.length,u=0;v>u&&!i;u++)for(var l=o[c[u]],E=l.length,f=0;E>f&&!a;f++){var h=l[f];h.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function a(e,t,n){var r=s(e,n,Object);return s(parseInt(t),r,Array)}function s(e,t,n){var r=null;return t.hasOwnProperty(e)?r=t[e]:n&&(r=t[e]=new n),r}function o(){this._listeners={}}return o.prototype.add=e,o.prototype.has=t,o.prototype.remove=n,o.prototype.removeAll=r,o.prototype.call=i,o}();return t.isObject=e,t.getEvent=n,t.Event=r,t}(),MessagePortDispatcher=function(){function e(n,r,i,a){function s(e){var n=t.fromJSON(e.data);n&&(n.dispatcherId===c?u.dispatchEvent(n.event):l.dispatchEvent(n.event))}function o(n,r,i){n=EventDispatcher.getEvent(n,r),a&&(n=a.call(this,n));var s=e.toJSON(new t(n,c));v.call(this,s,i)}n=n||self;var c="MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now()),v=r||function(e,t){n.postMessage(e,this.targetOrigin,t)},u=new EventDispatcher,l=new EventDispatcher(i);this.targetOrigin="*",this.addEventListener=l.addEventListener,this.hasEventListener=l.hasEventListener,this.removeEventListener=l.removeEventListener,this.removeAllEventListeners=l.removeAllEventListeners,this.dispatchEvent=o,Object.defineProperties(this,{sender:{value:u},receiver:{value:l},target:{value:n},dispatcherId:{value:c}}),n.addEventListener("message",s)}var t=function(){function t(e,t){this.event=e,this.dispatcherId=t}function n(){return{event:e.toJSON(this.event),dispatcherId:this.dispatcherId}}function r(n){var r=e.fromJSON(n);return t.isEvent(r)?r.event=e.fromJSON(r.event):r=null,r}function i(e){return EventDispatcher.isObject(e)&&e.hasOwnProperty("dispatcherId")&&e.hasOwnProperty("event")}return t.prototype.toJSON=n,t.fromJSON=r,t.isEvent=i,t}();e.toJSON=function(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)},e.fromJSON=function(e){var t;if(EventDispatcher.isObject(e))t=e;else try{t=JSON.parse(e)}catch(n){}return t};var n=null,r=null,i=null;return e.self=function(t,r){return n||(n=new e(self,null,t,r)),n},e.parent=function(t,n){return r||(r=new e(parent,null,t,n)),r},e.top=function(t,n){return i||(i=new e(top,null,t,n)),i},e}(),WorkerEventDispatcher=function(){function e(e,t,n,r){EventDispatcher.Event.call(this,e,t),this.sourceEvent=n,this.client=r}function t(t,n){function r(t){var n=a.create(t.ports[0],c.SHARED_WORKER_CLIENT);s.dispatchEvent(new e(e.CONNECT,n,t,n))}var i=t||self,s=new EventDispatcher(n);i.addEventListener("connect",r),this.addEventListener=s.addEventListener,this.hasEventListener=s.hasEventListener,this.removeEventListener=s.removeEventListener,this.removeAllEventListeners=s.removeAllEventListeners,v.setScopeHandlers(i,s),Object.defineProperties(this,{receiver:{value:s},target:{value:i}})}function n(e,t,n){function r(){e.start()}function i(){e.close()}v.call(this,e,t,n),this.start=r,this.close=i}function r(e,t,r,i){var a=e;EventDispatcher.isObject(e)||(a=new SharedWorker(String(e),t)),n.call(this,a.port,r,i),v.setAbstractWorkerHandlers(a,this.receiver)}function i(e,t,n){function r(){return i.terminate()}var i=e||self;EventDispatcher.isObject(i)||(i=new Worker(String(e))),v.call(this,i,t,n),v.setScopeHandlers(i,this.receiver),this.terminate=r}function a(e,t,n,r){e===s?Object.defineProperties(this,{type:{value:t}}):i.call(this,e,n,r)}var s={},o={};Object.defineProperties(o,{CONNECT:{value:"connect"},MESSAGE:{value:"message"},ERROR:{value:"error"},LANGUAGECHANGE:{value:"languagechange"},ONLINE:{value:"online"},OFFLINE:{value:"offline"}}),e.createHandler=function(t,n,r){function i(t){r.hasEventListener(a)&&r.dispatchEvent(new e(a,t,t))}var a=e.getWorkerEventType(t);return n.addEventListener(t,i),i},e.getWorkerEventType=function(t){var n="";switch(t){case o.CONNECT:n=e.CONNECT;break;case o.MESSAGE:n=e.MESSAGE;break;case o.ERROR:n=e.ERROR;break;case o.LANGUAGECHANGE:n=e.LANGUAGECHANGE;break;case o.ONLINE:n=e.ONLINE;break;case o.OFFLINE:n=e.OFFLINE}return n},Object.defineProperties(e,{CONNECT:{value:"worker:connect"},MESSAGE:{value:"worker:message"},ERROR:{value:"worker:error"},LANGUAGECHANGE:{value:"worker:languagechange"},ONLINE:{value:"worker:online"},OFFLINE:{value:"worker:offline"}});var c={};Object.defineProperties(c,{DEDICATED_WORKER:{value:"dedicated"},SHARED_WORKER:{value:"shared"},SHARED_WORKER_SERVER:{value:"sharedServer"},SHARED_WORKER_CLIENT:{value:"sharedClient"}});var v=function(){function t(e,t,n){function r(t,n){e.postMessage(t,n)}MessagePortDispatcher.call(this,e,r,t,n)}function n(t,n){e.createHandler(o.ERROR,t,n),e.createHandler(o.LANGUAGECHANGE,t,n),e.createHandler(o.ONLINE,t,n),e.createHandler(o.OFFLINE,t,n)}function r(t,n){e.createHandler(o.ERROR,t,n)}return t.setScopeHandlers=n,t.setAbstractWorkerHandlers=r,t}();return t.prototype=new a(s,c.SHARED_WORKER_SERVER),t.prototype.constructor=t,n.prototype=new a(s,c.SHARED_WORKER_CLIENT),n.prototype.constructor=n,r.prototype=new a(s,c.SHARED_WORKER),r.prototype.constructor=r,i.prototype=new a(s,c.DEDICATED_WORKER),i.prototype.constructor=i,a.WorkerEvent=e,a.WorkerType=c,a.Dedicated=i,a.Shared=r,a.Server=t,a.Client=n,a.create=function(e,a,s,o){var v=null;switch(a){default:case c.DEDICATED_WORKER:v=new i(e,s,o);break;case c.SHARED_WORKER:v=new r(e,null,s,o);break;case c.SHARED_WORKER_SERVER:v=new t(e,s);break;case c.SHARED_WORKER_CLIENT:v=new n(e,s,o)}return v},a.self=function(e,n){var r=null;return r="function"==typeof self.postMessage?new i(self,e,n):new t(self,e)},a}();',INTERFACE_SRC:'function generateWorkerBlobData(e){e=e instanceof Array?e:[String(e)];for(var t=e.length,n=0;t>n;n++)e[n]=WorkerInterface.fullImportScriptURL(e[n]);return generateBlob([Scripts.DEPS_SRC,Scripts.INTERFACE_SRC,Scripts.SELF_SRC.replace("{$}",e.join(\'", "\'))],"text/javascript;charset=UTF-8")}function generateBlob(e,t){var n=new Blob(e instanceof Array?e:[e],{type:t||"text/plain;charset=UTF-8"});return window.URL.createObjectURL(n)}function fullImportScriptURL(e){if(e.search(/^\\w+\\:\\/\\//)>=0)return e;var t=window.location.origin,n=window.location.pathname.match(/([^\\/\\\\]+)(?:\\/|\\\\)+/g);if("/"===e.charAt())t+=e;else if("../"===e.substr(0,3)){for(var r=e.match(/([^\\/\\\\]+)(?:\\/|\\\\)+/g);r.length&&n.length&&"../"===r[0];)r.shift(),n.pop();t+="/"+n.join("")+r.join("")+e.match(/[^\\/\\\\]*$/g)[0]}else t+="./"===e.substr(0,2)?"/"+n.join("")+e.substring(2):"/"+n.join("")+e;return t}function isStandalone(){return"undefined"!=typeof Scripts&&Scripts.hasOwnProperty("SELF_SRC")}function evaluateRequest(type,cmd,value,target){var handler,result=void 0;switch(type){case CommandType.CALL:with(target)cmd?(eval("handler = "+cmd),result=handler.apply(target,value)):result=target.apply(null,value);break;case CommandType.EXEC:with(target)eval("result = (function(target) { with(target){ return "+cmd+"; }})(target);");break;case CommandType.GET:with(target)eval("result = "+cmd);break;case CommandType.SET:eval("handler = function(value, target) { with(target) { "+cmd+" = value; } };"),handler(value,target);break;case CommandType.DESTROY_TARGET:TargetPool.instance.remove(target)}return result}function TargetPool(){var e=new Map;this.set=function(t){var n=null;if(TargetPool.isValidTarget(t))if(e.has(t))n=e.get(t);else{var r=getId();n=new RequestTargetLink(this,t,r),e.set(r,n),e.set(t,n)}return n},this.has=function(t){return e.has(t)},this.get=function(t){return e.get(t)},this.remove=function(t){var n=e.get(t);n&&(e["delete"](n.id),e["delete"](n.target),n.destroy())},this.clear=function(){for(var t=e.keys(),n=t.length,r=0;n>r;r++){var a=t[r];if("string"==typeof a){var o=e.get(a);o.destroy()}}e.clear()},Object.defineProperties(this,{id:{value:getId()}})}function WorkerInterfaceBase(e,t){function n(){l.removeEventListener(Events.READY_EVENT,n),f.resolve(RequestTargetLink.getLink(""))}function r(e){var t,n,r=e.data;try{n=r.target?TargetPool.instance.get(r.target):d,t=evaluateRequest(r.type,r.cmd,r.value,n)}catch(o){throw c({name:o.name,message:o.message},ResponseTypes.RESULT_FAILURE,r.id),o}t instanceof Promise?a(t,r.id):c(t,ResponseTypes.RESULT_SUCCESS,r.id)}function a(e,t){e.then(function(e){c(e,ResponseTypes.RESULT_SUCCESS,t)},function(e){c(e,ResponseTypes.RESULT_FAILURE,t)})}function o(e){var t=e.data,n=g[t.id];switch(delete g[t.id],t.type){default:throw new Error("Unknown package received:"+JSON.stringify(e));case ResponseTypes.RESULT_FAILURE:n.reject(t.value);break;case ResponseTypes.RESULT_SUCCESS:n.resolve(t.value)}}function i(e){return Events.internals[e.type]||(e={type:e.type,data:DataConverter.prepareToReceive(e.data,u)}),e}function s(e){return{type:e.type,data:DataConverter.prepareToSend(e.data)}}function u(e,t){var n=getId();return e.id=n,e.value=DataConverter.prepareToSend(e.value),t=t||createDeferred(n),g[n]=t,l.dispatchEvent(Events.REQUEST_EVENT,e),t.promise}function c(e,t,n){var r={id:n,type:t,value:e};l.dispatchEvent(Events.RESPONSE_EVENT,r)}var l=null,f=createDeferred(),p=new RequestTarget(f.promise,u),d={};e?(l=isStandalone()?WorkerEventDispatcher.create(generateWorkerBlobData(e),t||WorkerInterface.DEDICATED,i,s):WorkerEventDispatcher.create(e,t||WorkerInterface.DEDICATED,i,s),l.addEventListener(Events.READY_EVENT,n)):(l=WorkerEventDispatcher.self(i,s),l.dispatchEvent(Events.READY_EVENT),n());var g={};this.get=p.get.bind(p),this.set=p.set.bind(p),this.call=p.call.bind(p),this.execute=p.execute.bind(p),this.then=p.then,this["catch"]=p["catch"],Object.defineProperties(this,{dispatcher:{value:l},target:{value:this},pool:{get:function(){return d},set:function(e){d=e}}}),l.addEventListener(Events.REQUEST_EVENT,r),l.addEventListener(Events.RESPONSE_EVENT,o)}function create(e){return new WorkerInterface(e,WorkerInterface.DEDICATED)}var WorkerInterface,CommandType={GET:"get",SET:"set",CALL:"call",EXEC:"exec",DESTROY_TARGET:"destroyTarget"},Events={READY_EVENT:"~WI:Ready",REQUEST_EVENT:"~WI:Request",RESPONSE_EVENT:"~WI:Response",internals:{"~WI:Response":!0}},ResponseTypes={RESULT_SUCCESS:"success",RESULT_FAILURE:"failure"},getId=function(){var e="WI/"+String(Date.now())+"/",t=0;return function(){return e+String(++t)+"/"+String(Date.now())}}(),createDeferred=function(){function e(){this.promise=new Promise(function(e,t){this.resolve=e,this.reject=t}.bind(this))}function t(){return new e}return t}(),DataConverter=function(){function e(e){return"function"==typeof e.toJSON&&(e=e.toJSON()),e}function t(e,t){var n=RequestTargetLink.getLinkPoolId(e);return n===TargetPool.instance.id?(e=TargetPool.instance.get(RequestTargetLink.getLinkId(e)),e&&(e=e.target)):e=new RequestTarget(Promise.resolve(e),t),e}function n(e,t,n){for(var r=[],a=e.length,o=0;a>o;o++){var i=e[o];RequestTargetLink.isLink(i)?r[o]=t(i,n):r[o]=i}return r}function r(e,t,n){var r={};for(var a in e)if(e.hasOwnProperty(a)){var o=e[a];RequestTargetLink.isLink(e)?r[a]=t(o,n):r[a]=o}return r}function a(t){var a=t,o=typeof t;return"object"===o&&null!==t?RequestTargetLink.isLink(t)?a=e(t):t instanceof Array?a=n(t,e):t.constructor===Object&&(a=r(t,e)):"function"===o&&(a=TargetPool.instance.set(t).toJSON()),a}function o(e){return e&&(e.value=a(e.value)),e}function i(e,a){var o=e;return"object"==typeof e&&null!==e&&(RequestTargetLink.isLink(e)?o=t(e,a):e instanceof Array?o=n(e,t,a):e.constructor===Object&&(o=r(e,t,a))),o}function s(e,t){return e&&(e.value=i(e.value,t)),e}function u(e){return e instanceof RequestTarget&&e.target.status==TargetStatus.PENDING}function c(e){function t(e){return u(e)&&a.push(e),e}var a=[];return"object"==typeof e&&null!==e&&(u(e)?a.push(e):e instanceof Array?n(e,t):e.constructor===Object&&r(e,t)),a}return{prepareToSend:o,prepareToReceive:s,lookupForPending:c}}(),TargetStatus={PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected",DESTROYED:"destroyed"},RequestTarget=function(){function e(e,t,n,r){return pack={type:e,cmd:t,value:n,target:r}}function t(e,t){var n=t.promise;switch(this.status){case TargetStatus.PENDING:this._addToQueue(e,t);break;case TargetStatus.REJECTED:n=Promise.reject(new Error("Target object was rejected and cannot be used for calls."));break;case TargetStatus.DESTROYED:n=Promise.reject(new Error("Target object was destroyed and cannot be used for calls."));break;case TargetStatus.RESOLVED:this._sendRequestHandlerPrecondition(e,t)}return n}function n(e,t){var n=DataConverter.lookupForPending(e.value);n.length?Promise.all(n).then(function(){this._sendRequestHandler(e,t)}.bind(this)):this._sendRequestHandler(e,t)}function r(t,n,r){var a=e(t,n,r,this.id),o=this._applyRequest(a,createDeferred());return new f(o,this._sendRequestHandler)}function a(e){return this._sendRequest(CommandType.GET,e)}function o(e,t){return this._sendRequest(CommandType.SET,e,t)}function i(e,t){return t?t instanceof Array||(t=[t]):t=[],this._sendRequest(CommandType.CALL,e,t)}function s(e){return this._sendRequest(CommandType.EXEC,e)}function u(){return this.status===TargetStatus.PENDING||this.status===TargetStatus.RESOLVED}function c(){return this.id&&this.status===TargetStatus.RESOLVED}function l(){return{_targetLink_:{id:this.id,type:this.targetType,poolId:this.poolId}}}function f(e,t){function n(){var e=null;return p.canBeDestroyed()?(g=TargetStatus.DESTROYED,e=p._sendRequest(CommandType.DESTROY_TARGET)):e=Promise.reject(),e}function r(e){var t=f;return"boolean"!=typeof t&&(t="function"===RequestTargetLink.getLinkTargetType(e)?E&&1===E.length&&E[0][0].type==CommandType.CALL&&!d:E&&1===E.length&&!d),t}function a(e){return g=TargetStatus.RESOLVED,RequestTargetLink.isLink(e)&&(l=RequestTargetLink.getLinkData(e),f=r(e),f&&E[E.length-1][1].promise.then(n,n),e={target:p}),o(),e}function o(){for(;E&&E.length;){var e=E.shift(),t=e[0],n=e[1];t.target=l.id,p._sendRequestHandlerPrecondition(t,n)}E=null}function i(e){for(g=TargetStatus.REJECTED;E&&E.length;){var t=E.shift();t[1].reject(new Error("Target of the call was rejected and callcannot be sent."))}return E=null,e}function s(t,n){var r=e.then(t,n);return r&&(d=!0),r}function u(){var t=e["catch"].apply(e,arguments);return t&&(d=!0),t}function c(e,t){E.push([e,t])}var l,f,p=this,d=!1,g=TargetStatus.PENDING,E=[];Object.defineProperties(this,{id:{get:function(){return l?l.id:null},configurable:!0},target:{get:function(){return p}},targetType:{get:function(){return l?l.type:null},configurable:!0},poolId:{get:function(){return l?l.poolId:null},configurable:!0},temporary:{get:function(){return f},set:function(e){this.isActive()&&(f=Boolean(e),g==TargetStatus.RESOLVED&&this.destroy())}},status:{get:function(){return g},configurable:!0},_sendRequestHandler:{value:t,configurable:!0},_targetLink_:{value:this}}),e=e.then(a,i),this._addToQueue=c,this.then=s,this["catch"]=u,this.destroy=n}return f.prototype.get=a,f.prototype.set=o,f.prototype.call=i,f.prototype.execute=s,f.prototype.canBeDestroyed=c,f.prototype.isActive=u,f.prototype.toJSON=l,f.prototype._sendRequest=r,f.prototype._applyRequest=t,f.prototype._sendRequestHandlerPrecondition=n,f}(),RequestTargetLink=function(){function e(e,t,n){var r=!0;Object.defineProperties(this,{poolId:{get:function(){return e?e.id:null}},target:{get:function(){return t}},id:{get:function(){return n}},_targetLink_:{value:this}}),this.destroy=function(){r&&(r=!1,n=null,e=null,t=null,e.remove(n))}}return e.prototype.toJSON=function(){return{_targetLink_:{id:this.id,type:typeof this.target,poolId:this.poolId}}},e.getLink=function(e){return{_targetLink_:{id:e||0,poolId:TargetPool.instance.id}}},e.getLinkData=function(t){var n;return e.isLink(t)&&(n=t._targetLink_),n},e.getLinkId=function(t){var n;return e.isLink(t)&&(n=t._targetLink_.id),n},e.getLinkPoolId=function(t){var n;return e.isLink(t)&&(n=t._targetLink_.poolId),n},e.getLinkTargetType=function(t){var n;return e.isLink(t)&&(n=t._targetLink_.type),n},e.isLink=function(e){return"object"==typeof e&&"object"==typeof e._targetLink_&&e._targetLink_},e}();TargetPool.isValidTarget=function(){var e={object:!0,"function":!0};return function(t){return t&&e[typeof t]}}(),Object.defineProperties(TargetPool,{instance:{value:new TargetPool}}),WorkerInterface="function"==typeof Proxy?function(){function e(e){return{get:function(n,r){function a(){return i}var o;if(e[r])o=n.target[r];else{var i=n.target.get(r);a.target=i,o=t(a)}return o},apply:function(e,n,r){return t(e.target.call(null,r))},set:function(t,n,r){var a;return a=e[n]?t.target[n]=r:t.target.set(n,r)},has:function(t,n){return Boolean(e[n])},deleteProperty:function(e,t){return!1},ownKeys:function(e){return[]}}}function t(e){return new Proxy(e,r)}var n={target:!0,then:!0,"catch":!0,_targetLink_:!0,toJSON:!0},r=e(n),a={get:!0,set:!0,call:!0,execute:!0,target:!0,dispatcher:!0,then:!0,"catch":!0,pool:!0},o=e(a),i=new Proxy(WorkerInterfaceBase,{construct:function(e,t){function n(){return r}var r=new e(t[0],t[1],t[2],t[3]);return n.target=r,new Proxy(n,o)},get:function(e,t){return e[t]}});return Object.defineProperties(i,{proxyEnabled:{value:!0}}),i}():function(){function e(e,t){WorkerInterfaceBase.apply(this,arguments)}return Object.defineProperties(e,{proxyEnabled:{value:!1}}),e}(),WorkerInterface.create=create,WorkerInterface.isStandalone=isStandalone,WorkerInterface.generateBlob=generateBlob,WorkerInterface.fullImportScriptURL=fullImportScriptURL,WorkerInterface.DEDICATED=WorkerEventDispatcher.WorkerType.DEDICATED_WORKER,WorkerInterface.WorkerEventDispatcher=WorkerEventDispatcher;',SELF_SRC:'var api=WorkerInterface.self=new WorkerInterface;try{importScripts("{$}")}catch(error){console.log(error.name,error.message),console.log(error)}'};return eval(Scripts.DEPS_SRC+Scripts.INTERFACE_SRC),WorkerInterface});